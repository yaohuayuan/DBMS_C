# Updated GitHub Actions workflow for DBMS CI/CD

name: DBMS CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.27.2'

      - name: Configure CMake
        run: cmake -B build -S .

      - name: Build
        run: cmake --build build --config Release

      - name: Run Tests
        run: |
          cd build
          ctest --output-on-failure

  create-release:
    runs-on: ${{ matrix.os }}
    needs: build-and-test
    if: success() && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v1
        with:
          cmake-version: '3.27.2'

      - name: Configure CMake
        run: cmake -B build -S .

      - name: Build
        run: cmake --build build --config Release

      - name: Package executable
        id: package
        run: |
          mkdir -p release
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            cp build/DBMS release/DBMS-Linux
            echo "EXECUTABLE_PATH=release/DBMS-Linux" >> $GITHUB_ENV
          else
            cp build/DBMS.exe release/DBMS-Windows.exe
            echo "EXECUTABLE_PATH=release/DBMS-Windows.exe" >> $GITHUB_ENV
          fi

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: "Automated build from GitHub Actions for ${{ matrix.os }}"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.EXECUTABLE_PATH }}
